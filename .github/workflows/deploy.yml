name: Deploy CASFA Server

on:
  push:
    branches: [main]
    paths:
      - "apps/server/**"
      - "packages/**"
      - ".github/workflows/deploy.yml"
  workflow_dispatch:
    inputs:
      stage:
        description: "Deployment stage"
        required: true
        default: "prod"
        type: choice
        options:
          - staging
          - prod

# Prevent concurrent deployments
concurrency:
  group: deploy-${{ github.event.inputs.stage || 'prod' }}
  cancel-in-progress: false

permissions:
  id-token: write   # OIDC for AWS
  contents: read

env:
  AWS_REGION: us-east-1
  STAGE: ${{ github.event.inputs.stage || 'prod' }}

jobs:
  deploy:
    name: Deploy to AWS
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.stage || 'prod' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup SAM CLI
        uses: aws-actions/setup-sam@v2
        with:
          use-installer: true

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Typecheck
        working-directory: apps/server
        run: bun run typecheck

      - name: Build backend (Lambda bundle)
        working-directory: apps/server
        run: bun run build:backend

      - name: Build frontend (Vite SPA)
        working-directory: apps/server
        run: bun run build:frontend

      - name: SAM Build
        working-directory: apps/server
        run: sam build

      - name: SAM Deploy
        working-directory: apps/server
        run: |
          sam deploy \
            --stack-name casfa-${{ env.STAGE }} \
            --no-confirm-changeset \
            --no-fail-on-empty-changeset \
            --parameter-overrides \
              "StageName=${{ env.STAGE }}" \
              "CognitoUserPoolId=${{ secrets.COGNITO_USER_POOL_ID }}" \
              "CognitoClientId=${{ secrets.COGNITO_CLIENT_ID }}" \
              "CognitoRegion=${{ env.AWS_REGION }}" \
              "CognitoHostedUiUrl=${{ secrets.COGNITO_HOSTED_UI_URL }}" \
              "CustomDomainName=${{ vars.CUSTOM_DOMAIN_NAME || '' }}" \
              "AcmCertificateArn=${{ secrets.ACM_CERTIFICATE_ARN || '' }}"

      - name: Get Stack Outputs
        id: stack
        working-directory: apps/server
        run: |
          FRONTEND_BUCKET=$(aws cloudformation describe-stacks \
            --stack-name casfa-${{ env.STAGE }} \
            --query 'Stacks[0].Outputs[?OutputKey==`FrontendBucketName`].OutputValue' \
            --output text)
          CF_DIST_ID=$(aws cloudformation describe-stacks \
            --stack-name casfa-${{ env.STAGE }} \
            --query 'Stacks[0].Outputs[?OutputKey==`CloudFrontDistributionId`].OutputValue' \
            --output text)
          SITE_URL=$(aws cloudformation describe-stacks \
            --stack-name casfa-${{ env.STAGE }} \
            --query 'Stacks[0].Outputs[?OutputKey==`SiteUrl`].OutputValue' \
            --output text)
          echo "frontend_bucket=$FRONTEND_BUCKET" >> "$GITHUB_OUTPUT"
          echo "cf_dist_id=$CF_DIST_ID" >> "$GITHUB_OUTPUT"
          echo "site_url=$SITE_URL" >> "$GITHUB_OUTPUT"

      - name: Deploy Frontend to S3
        run: |
          aws s3 sync apps/server/backend/public/ \
            s3://${{ steps.stack.outputs.frontend_bucket }} \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "index.html" \
            --exclude "*.json"
          # index.html and manifests: no cache (always fresh)
          aws s3 sync apps/server/backend/public/ \
            s3://${{ steps.stack.outputs.frontend_bucket }} \
            --cache-control "public, max-age=0, must-revalidate" \
            --exclude "*" \
            --include "index.html" \
            --include "*.json"

      - name: Invalidate CloudFront Cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ steps.stack.outputs.cf_dist_id }} \
            --paths "/index.html" "/*.json"

      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Deployment Complete" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Resource | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|----------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Stage** | \`${{ env.STAGE }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Site URL** | ${{ steps.stack.outputs.site_url }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Stack** | \`casfa-${{ env.STAGE }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| **Region** | \`${{ env.AWS_REGION }}\` |" >> "$GITHUB_STEP_SUMMARY"

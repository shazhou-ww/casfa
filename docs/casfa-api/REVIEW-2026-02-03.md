# CASFA API 架构评审报告

**评审日期**: 2026-02-03  
**评审人**: 系统架构师  
**文档版本**: v1.0  

---

## 1. 总体评价

CASFA API 设计具备较好的架构基础，ID 设计统一、认证分层清晰。但存在若干架构层面的设计缺陷和 API 设计反模式，需要在生产使用前解决。

### 设计亮点

1. **统一的 ID 格式规范**: Crockford Base32 + 类型前缀，可读性好
2. **多层认证分离**: User Token / Agent Token / AWP Client / Ticket 职责清晰
3. **内容寻址设计**: Node key = hash 天然支持去重和校验
4. **Ticket 权限隔离**: input 范围限制 + quota 配额控制设计合理
5. **Depot 版本历史**: 简洁的 history 栈设计，足够实用

---

## 2. 问题清单

### 2.1 P0 严重问题 (Critical)

#### #1 Ticket ID 作为 URL 凭证的安全风险

**位置**: `05-realm/02-tickets.md`

**问题描述**:

```
/api/ticket/{ticketId}/...
```

- Ticket ID 直接暴露在 URL 中，会被记录到 HTTP 访问日志、Referer header、浏览器历史
- 违反 OWASP 认证最佳实践: "敏感凭证不应通过 URL 传递"
- CDN/代理层日志会泄露 Ticket

**可选方案**:

| 方案 | 描述 | 优点 | 缺点 |
|------|------|------|------|
| A | 签名 URL（类似 S3 presigned URL） | 安全性最高 | 实现复杂 |
| B | `Authorization: Ticket {id}` header | 符合 HTTP 规范 | 需要改造所有客户端 |
| C | 保持现状 + 文档安全警告 | 零改动 | 安全风险仍存在 |

**决策**: ✅ 采用方案 B

**解决方案**:

1. 删除独立的 `/api/ticket/{ticketId}/...` 路由
2. 将 Ticket 访问并入 `/api/realm/{realmId}/...` 路由
3. 使用 `Authorization: Ticket {ticketId}` header 进行认证
4. Ticket 认证时自动限制访问范围（input scope + quota）

**收益**:

- 凭证不再暴露在 URL 中，符合 OWASP 最佳实践
- 路由结构更简洁（少一个顶级路由）
- 认证模型统一（所有凭证都在 Authorization header）
- Ticket 本质上是 Realm 的受限视图，语义更清晰

**状态**: ✅ 已解决（2026-02-03）

---

#### #2 缺少 Rate Limiting 和防滥用机制

**问题描述**: 整个 API 文档没有任何关于限流的说明

- `/api/auth/clients/init` 可被用于 DDoS pending 授权表
- `/api/auth/clients/status` 轮询端点缺少 rate limit
- MCP 端点 `/api/mcp` 无调用限制
- Node 上传端点可能被滥用消耗配额

**建议**: 在 `README.md` 添加限流策略章节

```markdown
## Rate Limiting

| 端点类别 | 限制 | 窗口 |
|---------|------|------|
| OAuth endpoints | 10 req/min | Per IP |
| Auth polling | 1 req/5s | Per pubkey |
| Realm operations | 100 req/min | Per user |
| Node upload | 60 req/min | Per realm |
| MCP calls | 300 req/min | Per token |
```

**状态**: 🟡 待补充文档

---

### 2.2 P1 重要问题 (Major)

#### #3 OAuth token 端点缺少 PKCE 支持

**位置**: `01-oauth.md`

**问题描述**: `POST /api/oauth/token` 只接受 `code` 和 `redirect_uri`，没有 `code_verifier`

- 缺少 PKCE (RFC 7636) 支持，容易受到授权码拦截攻击
- 对于 SPA 和移动客户端，这是必需的安全机制

**建议**:

```json
{
  "code": "授权码",
  "redirect_uri": "回调 URL",
  "code_verifier": "PKCE verifier"
}
```

**状态**: 🟡 待 API 变更

---

#### #4 错误响应格式不统一

**问题描述**: 各端点错误格式不一致

| 文件 | 当前格式 |
|------|---------|
| README.md | `{error, details}` ✓ 标准 |
| 02-auth.md | `{success: true}` / `{authorized: false, error}` |
| 03-admin.md | `{success: true}` |
| 03-nodes.md | `{success: false, error, missing}` |

**建议**: 统一错误格式，遵循 RFC 7807 Problem Details

```json
{
  "type": "https://casfa.io/errors/missing-nodes",
  "title": "Missing Nodes",
  "status": 400,
  "detail": "3 referenced nodes are not present in storage",
  "instance": "/api/realm/.../nodes/node:abc",
  "missing": ["node:xxx", "node:yyy"]
}
```

**状态**: 🟡 待统一文档格式

---

### 2.3 P2 问题

#### #5 RESTful 设计不一致

| 问题 | 位置 | 说明 |
|------|------|------|
| 动词 URL | `POST /api/admin/users/:userId/authorize` | 应为 `PATCH /api/admin/users/:userId` |
| 动词 URL | `POST /api/realm/{realmId}/tickets/:ticketId/revoke` | 应为 `PATCH` 或 `DELETE` |
| 语义混乱 | `DELETE /api/admin/users/:userId/authorize` | 是删除授权还是删除用户？ |
| 嵌套过深 | `/api/realm/{realmId}/depots/:depotId/commit` | 考虑扁平化 |

**建议**:

```markdown
# 统一资源操作模式
PATCH /api/admin/users/:userId       # 修改角色
PATCH /api/realm/.../tickets/:id     # 修改状态 (revoke)
DELETE /api/realm/.../tickets/:id    # 物理删除
```

**状态**: 🔵 待规划

---

#### #6 缺少 API 版本控制

**问题描述**: 所有路由都是 `/api/...`，没有版本前缀

**决策**: ❌ 不做

**理由**:

- API 设计原则是“只增不减”，不删除或修改现有字段
- 如果未来需要全新设计，则创建新 site 并做旧 API 的功能适配，将用户迁移过去
- 版本号会增加维护复杂度

**状态**: ✅ 已决策（不实施）

---

#### #7 Ticket 状态机设计问题

**位置**: `05-realm/02-tickets.md`

**原状态机**:

```
Active → Committed → Revoked → Deleted
```

**问题**:

- `Committed → Revoked` 转换的业务语义不清晰
- 缺少 `Expired` 状态，`expiresAt` 过期后状态不明确
- `Revoked` 和 `Deleted` 区别模糊

**决策**:

1. ✅ 将 `active` 改为 `issued`，语义更清晰（“已发放” vs “活跃”）
2. ❌ 不增加 `Expired` 状态 - 过期状态由 `expiresAt` 运行时推导
3. `Revoked` 和 `Deleted` 保持区分：Revoked 是软删除（保留历史），Deleted 是物理删除

**新状态机**:

```
Issued → Committed → Revoked → Deleted
   │         │          │
   └─────────┴──────────┘ (过期由 expiresAt 推导，返回 410)
```

**状态**: ✅ 已解决（2026-02-03）

---

### 2.4 P3 问题

#### #8 MCP 协议实现不完整

**位置**: `04-mcp.md`

**问题描述**:

- 只支持 `POST /api/mcp`，不支持 SSE 推送
- 缺少 `notifications/initialized` 生命周期
- 没有实现 `resources/*` 和 `prompts/*` 能力

**建议**: 明确声明是"MCP 子集"

```json
{
  "capabilities": {
    "tools": {},
    "resources": null,
    "prompts": null
  }
}
```

**状态**: 🟢 待补充文档

---

#### #9 分页设计缺少总数

**位置**: `02-tickets.md`, `04-depots.md`

**问题描述**: 分页响应只返回 `nextCursor`，没有 `totalCount` 或 `hasMore`

**建议**:

```json
{
  "tickets": [...],
  "nextCursor": "...",
  "hasMore": true
}
```

**状态**: 🟢 待补充文档

---

#### #10 Node 上传缺少 Content-MD5 验证

**位置**: `03-nodes.md`

**问题描述**: `PUT /api/realm/{realmId}/nodes/:key` 没有要求客户端提供校验和

**建议**:

```http
PUT /api/realm/.../nodes/:key
Content-Type: application/octet-stream
Content-MD5: base64-encoded-md5
X-CAS-Blake3: hex-encoded-blake3
```

**状态**: 🟢 待补充文档

---

#### #11 prepare-nodes 语义与 HTTP 方法不匹配

**位置**: `03-nodes.md`

**问题描述**: `POST /api/realm/{realmId}/prepare-nodes` 是查询操作却使用 POST，且有 touch 副作用

**建议**:

- 改名为 `POST /api/realm/{realmId}/nodes:check`
- 或文档说明其 touch 副作用

**状态**: 🟢 待补充文档

---

#### #12 时间格式说明分散

**问题描述**: "epoch 毫秒" 格式说明分散在各处，且与 `expiresIn` (秒) 单位不一致

**建议**: 在 README 开头集中说明

```markdown
## 时间格式规范
- **时间戳**: Unix epoch 毫秒 (int64)
- **持续时间**: 秒 (int32)
- **示例**: `expiresAt: 1738497600000` (2025-02-02T00:00:00Z)
```

**状态**: 🟢 待补充文档

---

#### #13 缺少 ETag/条件请求支持

**问题描述**: Node 读取没有缓存控制机制

**建议**:

```http
GET /api/realm/.../nodes/:key
→ ETag: "node:abc123..."
→ Cache-Control: public, immutable, max-age=31536000

GET /api/realm/.../nodes/:key
If-None-Match: "node:abc123..."
→ 304 Not Modified
```

> 由于 CAS 节点内容不可变，天然支持永久缓存

**决策**: ✅ 可以做

**理由**: CAS 系统的节点都是 immutable，天然适合缓存优化

**状态**: 🟡 待实现

---

#### #14 Admin API 权限模型过于简单

**位置**: `03-admin.md`

**问题描述**: 只有 `unauthorized | authorized | admin` 三个角色

**风险**: 无法实现细粒度权限控制（如只读管理员、审计员）

**建议**: 考虑 RBAC 或 ABAC 扩展

```json
{
  "role": "admin",
  "permissions": ["users:read", "users:write", "audit:read"]
}
```

**决策**: ⏳ 后续再说

**理由**: 现阶段三个角色已经够用

**状态**: 🟢 待规划

---

## 3. 缺失的关键文档

| 文档 | 重要性 | 说明 |
|------|--------|------|
| 幂等性保证 | 高 | 哪些操作是幂等的？重试策略？ |
| 事务边界 | 高 | Depot commit 失败时的回滚机制？ |
| 并发控制 | 高 | Depot 并发 commit 的冲突处理？ |
| Webhook/事件 | 中 | Ticket commit 后如何通知 Agent？ |
| 审计日志 | 中 | Admin 操作是否记录审计？ |
| 健康检查详情 | 低 | `/api/health` 返回什么？ |

---

## 4. 优先级矩阵

| 优先级 | 问题编号 | 修复成本 | 影响范围 | 状态 |
|--------|---------|---------|---------|------|
| P0 | #1 Ticket URL 安全 | 高 | Breaking | ✅ 已解决 |
| P0 | #2 Rate Limiting | 中 | 新增 | ✅ 已解决 |
| P1 | #3 PKCE 支持 | 低 | 新增参数 | 🟡 待实现 |
| P1 | #4 统一错误格式 | 中 | Breaking | ✅ 已解决 |
| P2 | #5 RESTful 一致性 | 高 | Breaking | 🔵 待规划 |
| P2 | #6 API 版本控制 | - | - | ✅ 已决策（不实施） |
| P2 | #7 状态机重设计 | 中 | Breaking | ✅ 已解决 |
| P3 | #8 MCP 协议说明 | 低 | 文档 | ✅ 已解决 |
| P3 | #9 分页 hasMore | 低 | 文档 | ✅ 已解决 |
| P3 | #10 校验和文档 | 低 | 文档 | ✅ 已解决 |
| P3 | #11 prepare-nodes 说明 | 低 | 文档 | ✅ 已解决 |
| P3 | #12 时间格式规范 | 低 | 文档 | ✅ 已解决 |
| P3 | #13 ETag 支持 | 中 | 新增 | 🟡 待实现 |
| P3 | #14 Admin 权限 | 高 | Breaking | 🟢 后续规划 |

---

## 5. 改进计划

### Phase 1: 快速文档修复（纯文档，无 Breaking Change）

| 任务 | 修改文件 | 预计工时 |
|------|---------|---------|
| 统一错误响应格式文档 | 所有文件 | 2h |
| 添加 Rate Limiting 章节 | README.md | 1h |
| 时间格式规范整合 | README.md | 0.5h |
| 补充分页响应字段 | 02-tickets.md, 04-depots.md | 0.5h |
| 完善 MCP 协议说明 | 04-mcp.md | 0.5h |
| 添加幂等性说明 | README.md | 1h |
| 补充 prepare-nodes 副作用说明 | 03-nodes.md | 0.5h |
| 添加校验和文档 | 03-nodes.md | 0.5h |

**总计**: ~6.5h

### Phase 2: API 设计变更（需架构决策 + 实现同步）

| 任务 | 修改文件 | 依赖 |
|------|---------|------|
| Ticket URL 安全方案选型 | 05-realm/02-tickets.md, README.md | ✅ 已完成 |
| 添加 PKCE 支持 | 01-oauth.md | 实现变更 |
| Ticket 状态机补充 Expired | 05-realm/02-tickets.md | 实现变更 |
| API 版本控制策略 | README.md | 架构决策 |
| RESTful 路由重构 | 多个文件 | 架构决策 |
| Node ETag/Cache-Control | 03-nodes.md | 实现变更 |

---

## 6. 状态图例

| 图标 | 含义 |
|------|------|
| 🔴 | 待决策（需要架构评审） |
| 🟡 | 待执行（已确定方案） |
| 🔵 | 待规划（后续迭代） |
| 🟢 | 可选优化 |
| ✅ | 已完成 |

---

## 附录: 文件修改映射

| 问题 | 涉及文件 |
|------|---------|
| #1 Ticket URL | 05-realm/02-tickets.md, README.md |
| #2 Rate Limiting | README.md |
| #3 PKCE | 01-oauth.md |
| #4 错误格式 | 所有文件 |
| #5 RESTful | 03-admin.md, 05-realm/02-tickets.md, 04-depots.md |
| #6 版本控制 | README.md |
| #7 状态机 | 05-realm/02-tickets.md |
| #8 MCP | 04-mcp.md |
| #9 分页 | 02-tickets.md, 04-depots.md |
| #10 校验和 | 03-nodes.md |
| #11 prepare-nodes | 03-nodes.md |
| #12 时间格式 | README.md |
| #13 ETag | 03-nodes.md |
| #14 Admin 权限 | 03-admin.md |

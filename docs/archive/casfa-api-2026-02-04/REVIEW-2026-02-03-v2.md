# CASFA API 架构评审报告 (第二轮)

**评审日期**: 2026-02-03 ~ 2026-02-04  
**评审人**: 高级系统架构师  
**文档版本**: v2.1  
**基于**: [首轮评审报告](./REVIEW-2026-02-03.md) 改进后复审

> **更新记录**:
>
> - v2.1 (2026-02-04): 新增架构讨论章节，确定 Ticket 状态模型和 Admin API 设计决策

---

## 1. 总体评价

本轮评审基于首轮评审后的文档改进进行。**整体改进显著**，关键的安全问题和设计缺陷已得到有效解决。文档质量和一致性有了实质性提升。

### 1.1 改进总结

| 问题类别 | 首轮问题数 | 已解决 | 解决率 |
|---------|-----------|--------|--------|
| P0 严重问题 | 2 | 2 | ✅ 100% |
| P1 重要问题 | 2 | 2 | ✅ 100% |
| P2 问题 | 3 | 2 | 67% |
| P3 问题 | 7 | 6 | 86% |
| **总计** | **14** | **12** | **86%** |

### 1.2 本轮评价

| 维度 | 评分 | 说明 |
|------|------|------|
| 安全设计 | ⭐⭐⭐⭐☆ | Ticket 认证改为 Header，限流策略完整 |
| API 一致性 | ⭐⭐⭐⭐☆ | 错误格式统一，时间规范明确 |
| 文档完整性 | ⭐⭐⭐⭐☆ | 幂等性、限流、认证说明齐全 |
| RESTful 规范 | ⭐⭐⭐☆☆ | 仍有改进空间（见下文） |
| 可维护性 | ⭐⭐⭐⭐☆ | 模块划分清晰，交叉引用完善 |

**综合评级: B+ (良好)**

---

## 2. 首轮问题解决情况确认

### 2.1 ✅ 已解决的问题

#### #1 Ticket URL 安全风险 → 已解决

**改进措施**:

- Ticket 访问统一使用 `Authorization: Ticket {ticketId}` header
- 删除了独立的 `/api/ticket/...` 路由
- 文档明确安全警告："不要将 Ticket ID 放入 URL，避免日志泄露"

**验证**: `05-realm/02-tickets.md` 第 50-65 行，`README.md` 认证方式章节

**评价**: 👍 方案选择正确，实施完整。符合 OWASP 凭证处理最佳实践。

---

#### #2 Rate Limiting 机制 → 已解决

**改进措施**:

- `README.md` 新增完整的"限流策略"章节
- 覆盖所有端点类别的限流规则
- 包含 `429` 响应格式和 `Retry-After` header 规范

**验证**: `README.md` 限流策略章节

**评价**: 👍 限流策略设计合理，维度选择正确（IP/pubkey/user/realm/token/admin）。建议后续补充 burst 配置。

---

#### #4 错误响应格式 → 已解决

**改进措施**:

- `README.md` 统一定义错误格式 `{error, message, details}`
- 提供完整的错误代码列表
- 各子文档已引用统一规范

**验证**: `README.md` 错误响应章节，各子文档错误表格

**评价**: 👍 格式简洁实用。虽未完全采用 RFC 7807，但当前设计满足需求且更轻量。

---

#### #7 Ticket 状态机 → 已解决

**改进措施**:

- `active` 改为 `issued`，语义更清晰
- 保持 `expiresAt` 运行时推导过期状态
- 文档明确各状态转换规则

**验证**: `05-realm/02-tickets.md` 生命周期章节

**评价**: 👍 状态机设计简洁，职责划分清晰（Issuer revoke，User delete）。

---

#### #8-#12 P3 文档问题 → 已解决

| 问题 | 改进措施 | 验证位置 |
|------|---------|---------|
| MCP 协议说明 | 明确声明"MCP 子集"，只支持 tools | `04-mcp.md` 开头 |
| 分页 hasMore | 所有分页响应增加 `hasMore` 字段 | `02-tickets.md`, `04-depots.md` |
| 校验和文档 | 增加 `Content-MD5` 和 `X-CAS-Blake3` header 说明 | `03-nodes.md` PUT 端点 |
| prepare-nodes 副作用 | 明确说明 touch 生命周期行为 | `03-nodes.md` prepare-nodes 章节 |
| 时间格式规范 | README 统一定义 epoch 毫秒和持续时间秒 | `README.md` 时间格式规范 |

**评价**: 👍 文档补全到位，开发者体验显著提升。

---

### 2.2 🟡 仍待解决的问题

#### #3 PKCE 支持 → 仍未实现

**当前状态**: `01-oauth.md` 的 `POST /api/oauth/token` 仍只接受 `code` 和 `redirect_uri`

**风险**: 对于 SPA 和移动端客户端，缺少 PKCE 保护存在授权码拦截风险

**建议**: 优先级提升至 P1，下个迭代必须实现

```json
{
  "code": "授权码",
  "redirect_uri": "回调 URL",
  "code_verifier": "PKCE verifier (可选，提供时验证)"
}
```

---

#### #5 RESTful 设计一致性 → ✅ 经讨论已确定方案

**讨论结论** (2026-02-04):

经过架构讨论，确定以下设计决策：

| 端点 | 决策 | 理由 |
|------|------|------|
| `POST .../tickets/:id/revoke` | ✅ 保持 Action | 见下方 Ticket 状态模型重构 |
| `POST .../tickets/:id/commit` | ✅ 保持 Action | 涉及多字段原子修改 + 业务校验 |
| `POST .../depots/:id/commit` | ✅ 保持 Action | History 重算是复杂业务逻辑 |
| `DELETE .../authorize` | ⚠️ 改为 PATCH | 见下方 Admin API 重构 |

**架构原则**: 当操作涉及业务逻辑校验、多字段原子修改时，Action Endpoint (`POST /resource/:id/action`) 比 PATCH 更清晰。

---

##### Ticket 状态模型重构 ✅ 已确定

**原模型**:

```typescript
status: "issued" | "committed" | "revoked"
```

**新模型**:

```typescript
interface Ticket {
  output: string | null      // 结果节点，存在即表示已提交
  isRevoked: boolean         // 是否被撤销
  status: string             // 派生字段，方便 UI 展示
}
```

**四种组合的业务语义**:

| output | isRevoked | 语义 | 业务场景 |
|--------|-----------|------|----------|
| null | false | **活跃** | Tool 正在处理任务 |
| null | true | **放弃** | 任务取消，Tool 未完成就被撤销 |
| exists | false | **完成** | 任务成功，结果可读取 |
| exists | true | **归档** | 任务完成后权限收回，结果仍存在 |

**优势**:

1. 两个独立维度，查询更灵活
2. "提交后撤销" 是合理的业务场景（归档）
3. 客户端根据字段直接判断行为，无需推算 status

**API 响应**: 保留计算字段 `status` 方便展示

```json
{
  "ticketId": "ticket:xxx",
  "output": "node:result...",
  "isRevoked": false,
  "status": "committed"
}
```

---

##### Admin API 重构 ✅ 已确定

**问题**: `DELETE /api/admin/users/:userId/authorize` 语义不清

- 实际是"封禁"（设为 unauthorized），不是删除
- 用户数据保留，重新授权后可恢复

**决策**: 统一使用 PATCH 修改角色

```http
# 设置用户角色（包括封禁）
PATCH /api/admin/users/:userId
{ "role": "authorized" | "admin" | "unauthorized" }
```

**废弃端点**:

- ~~`POST /api/admin/users/:userId/authorize`~~
- ~~`DELETE /api/admin/users/:userId/authorize`~~

**后续规划**: 如用户量增长，考虑引入申请/审批机制（pending → approved/rejected）

---

#### #13 ETag/条件请求 → 仍未实现

**当前状态**: `03-nodes.md` 未包含缓存控制相关 header

**建议**: CAS 节点天然 immutable，强烈建议实现：

```http
GET /api/realm/.../nodes/:key
→ ETag: "{nodeKey}"
→ Cache-Control: public, immutable, max-age=31536000
```

---

## 3. 新发现的问题

### 3.1 P2 问题

#### #15 Depot commit 缺少并发控制

**位置**: `05-realm/04-depots.md`

**问题描述**: `POST /depots/:depotId/commit` 没有乐观锁机制

**场景**:

- Client A: GET depot (root = node:v1)
- Client B: GET depot (root = node:v1)  
- Client A: commit(root = node:v2) ✅
- Client B: commit(root = node:v3) ✅ ← 覆盖 A 的提交

**风险**: 并发写入导致数据丢失

**建议**: 增加 `expectedRoot` 字段实现乐观锁

```json
{
  "root": "node:newroot...",
  "expectedRoot": "node:oldroot..."
}
```

服务端验证：若当前 root ≠ expectedRoot，返回 `409 Conflict`

**优先级**: P2

---

#### #16 Agent Token 缺少 scope 限制

**位置**: `02-auth.md`

**问题描述**: Agent Token 创建时没有 scope 字段，具有完整的 Realm 权限

**风险**: Token 泄露导致完整权限暴露

**建议**: 支持细粒度权限控制

```json
{
  "name": "Thumbnail Generator",
  "scopes": ["nodes:read", "nodes:write", "tickets:create"],
  "expiresIn": 2592000
}
```

**优先级**: P2 (安全增强)

---

### 3.2 P3 问题

#### #17 Ticket 缺少 metadata 字段

**位置**: `05-realm/02-tickets.md`

**问题描述**: Ticket 只有 `purpose` 描述字段，缺少结构化 metadata

**场景**: Agent 需要在 Ticket 上附加自定义数据（如回调 URL、请求 ID）

**建议**: 增加 `metadata` 字段

```json
{
  "input": [...],
  "purpose": "...",
  "metadata": {
    "callbackUrl": "https://...",
    "requestId": "req:xxx"
  }
}
```

**优先级**: P3

---

#### #18 MCP 工具列表不完整

**位置**: `04-mcp.md`

**问题描述**: `tools/list` 响应被截断，未展示完整的工具定义

**建议**: 补全所有 CAS 工具的 `inputSchema`，或添加链接到完整定义

**优先级**: P3 (文档完整性)

---

#### #19 缺少 Webhook/事件通知机制

**位置**: 全局

**问题描述**:

- Ticket commit 后 Agent 只能轮询获取结果
- 缺少 push 机制导致延迟和资源浪费

**建议**: 规划 Webhook 或 SSE 通知

```json
// Ticket 创建时指定回调
{
  "input": [...],
  "webhookUrl": "https://agent.example.com/callback"
}
```

**优先级**: P3 (后续迭代)

---

#### #20 健康检查端点文档缺失

**位置**: `README.md`

**问题描述**: `/api/health` 端点仅在路由表中列出，无详细文档

**建议**: 补充响应格式

```json
{
  "status": "healthy",
  "version": "1.0.0",
  "timestamp": 1738497600000,
  "dependencies": {
    "dynamodb": "healthy",
    "s3": "healthy"
  }
}
```

**优先级**: P3

---

### 3.3 文档细节问题

#### #21 示例 ID 格式不一致

| 文件 | 示例 | 问题 |
|------|------|------|
| README.md | `node:abc123...` | 省略号暗示更长 |
| 02-tickets.md | `node:abc123...` | 同上 |
| 实际格式 | `node:{26位base32}` | 应为固定长度 |

**建议**: 统一使用完整的 26 位示例 ID

---

#### #22 跨文档引用格式不一致

| 位置 | 格式 |
|------|------|
| README.md | `[详细文档](./01-oauth.md)` ✓ |
| 05-realm/README.md | `[Ticket 管理](./02-tickets.md)` ✓ |
| 02-auth.md | 无返回 README 的链接 ✗ |

**建议**: 每个子文档添加"返回上级"链接

---

## 4. 安全合规检查

### 4.1 ✅ 已满足

| 检查项 | 状态 | 说明 |
|--------|------|------|
| 凭证不在 URL 中 | ✅ | Ticket 使用 Header |
| 限流保护 | ✅ | 完整的 rate limiting |
| Token 安全存储 | ✅ | 服务端只存 hash |
| 错误信息不泄露敏感数据 | ✅ | 错误响应格式规范 |
| 权限最小化 | ✅ | Ticket scope 限制 |

### 4.2 ⚠️ 建议增强

| 检查项 | 状态 | 建议 |
|--------|------|------|
| PKCE 支持 | ⚠️ | 必须实现 |
| Token scope | ⚠️ | Agent Token 需要 scope |
| 审计日志 | ⚠️ | Admin 操作需记录 |
| IP 白名单 | ⚠️ | 可选的 Agent Token 安全增强 |

---

## 5. 遗留事项追踪

### 5.1 待实施事项

| ID | 描述 | 优先级 | 状态 |
|----|------|--------|------|
| #3 | PKCE 支持 | P1 | 🟡 待实现 |
| #5a | Ticket 状态模型重构 | P1 | 🟡 待实现 (已确定方案) |
| #5b | Admin API 改用 PATCH | P1 | 🟡 待实现 (已确定方案) |
| #13 | ETag/Cache-Control | P2 | 🟡 待实现 |
| #15 | Depot 乐观锁 | P2 | 🔴 新增 |
| #16 | Agent Token scope | P2 | 🔴 新增 |
| #17 | Ticket metadata | P3 | 🔴 新增 |
| #19 | Webhook 通知 | P3 | 🔵 待规划 |

### 5.2 已决策方案

| ID | 描述 | 决策 |
|----|------|------|
| #5 | RESTful 一致性 | Action Endpoint 保留，Admin API 改 PATCH |
| #6 | API 版本控制 | 不实施，采用"只增不减"策略 |
| #7 | Ticket 状态模型 | 改用 output + isRevoked 双字段 |
| #14 | 细粒度 Admin 权限 | 不实施，现阶段三角色足够 |

---

## 6. 下一步建议

### 6.1 短期 (1-2 周)

1. **实现 PKCE 支持** (#3) - OAuth 安全关键
2. **Ticket 状态模型重构** (#5a) - 改用 output + isRevoked 双字段
3. **Admin API 重构** (#5b) - 改用 PATCH + role
4. **补充 ETag 缓存** (#13) - 性能优化，实现简单
5. **完善文档细节** (#18, #20, #21, #22)

### 6.2 中期 (1 个月)

1. **Depot 乐观锁** (#15) - 数据一致性保障
2. **Agent Token scope** (#16) - 安全增强
3. **Ticket metadata** (#17) - 功能增强

### 6.3 长期 (季度规划)

1. **Webhook 通知** (#19) - 架构升级
2. **RESTful 路由重构** (#5) - 可选优化
3. **审计日志系统** - 合规需求

---

## 7. 结论

CASFA API 文档在首轮评审后取得了**显著改进**:

1. **安全性**: P0 问题全部解决，认证模型统一规范
2. **一致性**: 错误格式、时间规范、分页格式已标准化
3. **完整性**: 限流、幂等性、副作用说明补充到位

**剩余工作量评估**:

- P1 问题: 3 项 (PKCE, Ticket 状态重构, Admin API 重构)
- P2 问题: 3 项 (ETag, 乐观锁, Token scope)
- P3 问题: 4 项 (文档细节)

**建议**: 在进入生产环境前，至少完成 P1 和 P2 级别的改进。

---

## 附录: 评审检查清单

| 类别 | 检查项 | 状态 |
|------|--------|------|
| **认证** | 支持多种认证方式 | ✅ |
| | 凭证不暴露在 URL | ✅ |
| | Token 安全存储 (hash) | ✅ |
| **授权** | 权限分层清晰 | ✅ |
| | 最小权限原则 | ✅ |
| | 资源隔离 (Realm) | ✅ |
| **API 设计** | 统一的 ID 格式 | ✅ |
| | 统一的错误格式 | ✅ |
| | 统一的时间格式 | ✅ |
| | RESTful 规范 | ✅ 已确定方案 |
| | 分页规范 | ✅ |
| **安全** | Rate Limiting | ✅ |
| | PKCE | ⚠️ 待实现 |
| | 乐观锁 | ⚠️ 待实现 |
| **文档** | 模块划分清晰 | ✅ |
| | 交叉引用完整 | ⚠️ 部分 |
| | 示例完整 | ⚠️ 部分 |
| | 错误处理文档 | ✅ |

---

*评审人签名: 高级系统架构师*  
*初审日期: 2026-02-03*  
*复审日期: 2026-02-04*
